<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Point Selector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: row;
            margin: 0;
            overflow: hidden;
        }

        #info {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        #info h2 {
            margin-bottom: 10px;
            color: #333;
            font-size: 18px;
        }

        #coordinates {
            font-family: 'Courier New', monospace;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #555;
        }

        .coord-row {
            margin: 5px 0;
        }

        .label {
            font-weight: bold;
            color: #1a73e8;
        }

        #instructions {
            margin-top: 10px;
            padding: 10px;
            background: #e8f0fe;
            border-radius: 6px;
            color: #1967d2;
            font-size: 14px;
        }

        #eta-section {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }

        #eta-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .eta-row {
            margin: 8px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-name {
            font-weight: 600;
            color: #555;
        }

        .mode-time {
            color: #1a73e8;
            font-weight: bold;
        }

        .compass {
            font-size: 24px;
            margin-left: 10px;
            display: inline-block;
            transition: transform 0.3s ease;
        }

        button {
            margin-top: 10px;
            padding: 12px 24px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background: #1557b0;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #submitBtn {
            background: #34a853;
            margin-top: 15px;
        }

        #submitBtn:hover {
            background: #2d8e47;
        }

        #result {
            margin-top: 15px;
            padding: 15px;
            background: #f0f7ff;
            border: 2px solid #1a73e8;
            border-radius: 6px;
            display: none;
        }

        #result h3 {
            margin-bottom: 10px;
            color: #1a73e8;
            font-size: 16px;
        }

        .result-row {
            margin: 5px 0;
            font-size: 14px;
        }

        .result-label {
            font-weight: bold;
            color: #555;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        #newGameBtn {
            background: #ea4335;
            display: none;
        }

        #newGameBtn:hover {
            background: #c5221f;
        }

        #compass-indicator {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            display: none;
        }

        #compass-indicator h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .compass-display {
            font-size: 48px;
            margin: 10px 0;
        }

        #score-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px 60px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #score-popup.show {
            opacity: 1;
        }

        .score-value {
            font-size: 72px;
            font-weight: bold;
            color: #1a73e8;
            margin: 0;
        }

        .score-label {
            font-size: 24px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>ETA Guesser - Toronto</h2>
        <button id="randomBtn" onclick="getRandomDestination()">New Game</button>
        <button id="newGameBtn" onclick="startNewGame()">New Game</button>

        <div id="coordinates">
            <div class="coord-row"><span class="label">Origin:</span> <span>Union Station, Toronto</span></div>
            <div class="coord-row"><span class="label">Destination:</span> <span id="destination">Click button to pick random destination</span></div>
        </div>

        <div id="compass-indicator">
            <h3>Direction to Destination</h3>
            <div class="compass-display" id="compass-arrow"></div>
        </div>

        <div id="eta-section" style="display: none;">
            <h3>Travel Times from Union Station</h3>
            <div id="eta-content"></div>
        </div>

        <button id="submitBtn" onclick="submitGuess()" style="display: none;">Submit My Guess</button>

        <div id="result">
            <h3>Results</h3>
            <div id="result-content"></div>
        </div>

        <div id="instructions">
            Click "New Game" to select a random location within 10km of Union Station and see ETAs. Ferry routes are excluded.
        </div>
    </div>

    <div id="map"></div>

    <div id="score-popup">
        <p class="score-value" id="score-value">0</p>
        <p class="score-label">points</p>
    </div>

    <script>
        let map;
        let destinationMarker;
        let guessMarker;
        let unionStationMarker;
        let distanceLine = null;
        let actualDestination = null;
        let gameActive = false;
        let mapClickListener = null;
        let trafficLayer;
        let transitLayer;

        // Toronto Union Station coordinates
        const UNION_STATION = { lat: 43.6452, lng: -79.3806 };

        function calculateBearing(lat1, lng1, lat2, lng2) {
            // Calculate bearing/direction from point 1 to point 2
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;

            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);

            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360; // Normalize to 0-360
        }

        function getCompassArrow(bearing) {
            // Rotate arrow based on bearing (0¬∞ = North, 90¬∞ = East, etc.)
            return `<span class="compass" style="transform: rotate(${bearing}deg);">‚Üë</span>`;
        }

        function calculateScore(distanceKm) {
            // Geoguessr-style scoring: max 5000 points
            // Score decreases exponentially with distance
            // Perfect guess (0km) = 5000 points
            // ~1km = ~4500 points
            // ~5km = ~3000 points
            // ~10km = ~1500 points
            // ~25km = ~100 points
            const maxScore = 5000;
            const decayFactor = 0.25; // Controls how quickly score drops
            const score = Math.round(maxScore * Math.exp(-decayFactor * Math.max(0, distanceKm-0.05)));
            return Math.max(0, Math.min(maxScore, score));
        }

        function showScoreAnimation(score) {
            const popup = document.getElementById('score-popup');
            const scoreValue = document.getElementById('score-value');

            scoreValue.textContent = score;
            popup.classList.add('show');

            setTimeout(() => {
                popup.classList.remove('show');
            }, 1000);
        }

        function startNewGame() {
            // Hide new game button, will show submit after placing guess
            document.getElementById('newGameBtn').style.display = 'none';
            document.getElementById('randomBtn').style.display = 'block';

            // Start new game
            getRandomDestination();
        }

        function initMap() {
            // Create map centered on Toronto
            map = new google.maps.Map(document.getElementById('map'), {
                center: UNION_STATION,
                zoom: 11,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
            });

            // Add traffic layer
            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);

            // Add transit layer
            transitLayer = new google.maps.TransitLayer();
            transitLayer.setMap(map);

            // Add marker for Union Station
            unionStationMarker = new google.maps.Marker({
                position: UNION_STATION,
                map: map,
                title: 'Union Station',
                label: 'A',
                animation: google.maps.Animation.DROP
            });

            // Auto-pick destination on load
            getRandomDestination();
        }

        function enableMapGuessing() {
            // Remove previous listener if exists
            if (mapClickListener) {
                google.maps.event.removeListener(mapClickListener);
            }

            // Add click listener for guessing
            mapClickListener = map.addListener('click', (event) => {
                if (!gameActive) return;

                placeGuessMarker(event.latLng);
            });
        }

        function placeGuessMarker(location) {
            // Remove existing guess marker if any
            if (guessMarker) {
                guessMarker.setMap(null);
            }

            // Create new guess marker
            guessMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: 'Your Guess',
                label: '?',
                animation: google.maps.Animation.DROP,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#FFA500',
                    fillOpacity: 0.8,
                    strokeColor: '#FF8C00',
                    strokeWeight: 2
                }
            });

            // Show submit button
            document.getElementById('submitBtn').style.display = 'block';
        }

        async function getRandomDestination() {
            const button = document.getElementById('randomBtn');
            const newGameBtn = document.getElementById('newGameBtn');
            const etaSection = document.getElementById('eta-section');
            const etaContent = document.getElementById('eta-content');
            const destinationText = document.getElementById('destination');
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            const instructionsDiv = document.getElementById('instructions');
            const compassIndicator = document.getElementById('compass-indicator');

            // Reset game state and clear all old markers/lines
            gameActive = false;
            actualDestination = null;
            if (destinationMarker) {
                destinationMarker.setMap(null);
                destinationMarker = null;
            }
            if (guessMarker) {
                guessMarker.setMap(null);
                guessMarker = null;
            }
            if (distanceLine) {
                distanceLine.setMap(null);
                distanceLine = null;
            }
            submitBtn.style.display = 'none';
            newGameBtn.style.display = 'none';
            resultDiv.style.display = 'none';
            compassIndicator.style.display = 'none';

            // Disable button and show loading
            button.disabled = true;
            button.textContent = 'Loading...';
            destinationText.textContent = 'Picking random destination...';
            etaContent.innerHTML = '<div class="loading">Calculating ETAs...</div>';
            etaSection.style.display = 'block';

            try {
                // Call backend (deployed on Heroku)
                const response = await fetch('https://toronto-etaguessr-api-cdf6cdc7db27.herokuapp.com');
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Store destination (don't show it yet!)
                actualDestination = {
                    lat: data.destination.lat,
                    lng: data.destination.lng,
                    address: data.destination_address,
                    etas: data.etas
                };

                // Update destination display to hide address
                destinationText.textContent = '??? (Click on map to guess!)';

                // Display ETAs
                displayETAs(data.etas);

                // Enable game mode
                gameActive = true;
                enableMapGuessing();

                // Update instructions
                instructionsDiv.innerHTML = 'Based on the travel times and direction shown above, click on the map to guess where the destination is, then click "Submit My Guess".';
                instructionsDiv.style.background = '#fff3cd';
                instructionsDiv.style.color = '#856404';

                // Reset map view to Union Station
                map.setCenter(UNION_STATION);
                map.setZoom(11);

            } catch (error) {
                console.error('Error:', error);
                destinationText.textContent = 'Error getting destination';
                etaContent.innerHTML = '<div class="loading">Error: ' + error.message + '</div>';
            } finally {
                button.disabled = false;
                button.textContent = 'New Game';
            }
        }

        function displayETAs(etas) {
            if (!actualDestination) return;

            const etaContent = document.getElementById('eta-content');
            const compassIndicator = document.getElementById('compass-indicator');
            const compassArrow = document.getElementById('compass-arrow');

            const modes = [
                { key: 'driving', name: 'üöó Driving', icon: 'üöó' },
                { key: 'transit', name: 'üöá Public Transit', icon: 'üöá' },
                { key: 'bicycling', name: 'üö¥ Cycling', icon: 'üö¥' },
                { key: 'walking', name: 'üö∂ Walking', icon: 'üö∂' }
            ];

            // Calculate bearing to destination and show compass
            const bearing = calculateBearing(
                UNION_STATION.lat, UNION_STATION.lng,
                actualDestination.lat, actualDestination.lng
            );
            compassArrow.innerHTML = getCompassArrow(bearing);
            compassIndicator.style.display = 'block';

            // Display ETAs without compass arrows
            let html = '';
            modes.forEach(mode => {
                const eta = etas[mode.key];
                if (eta && !eta.error) {
                    html += `
                        <div class="eta-row">
                            <span class="mode-name">${mode.name}</span>
                            <span class="mode-time">${eta.duration}</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="eta-row">
                            <span class="mode-name">${mode.name}</span>
                            <span class="mode-time" style="color: #999;">N/A</span>
                        </div>
                    `;
                }
            });

            etaContent.innerHTML = html;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula to calculate distance in km
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function submitGuess() {
            if (!guessMarker || !actualDestination) {
                alert('Please place a guess marker on the map first!');
                return;
            }

            // Disable game mode
            gameActive = false;
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('randomBtn').style.display = 'none';

            // Get guess coordinates
            const guessPos = guessMarker.getPosition();
            const guessLat = guessPos.lat();
            const guessLng = guessPos.lng();

            // Calculate distance and score
            const distanceKm = calculateDistance(
                guessLat, guessLng,
                actualDestination.lat, actualDestination.lng
            );
            const distanceMiles = distanceKm * 0.621371;
            const score = calculateScore(distanceKm);

            // Show score animation
            showScoreAnimation(score);

            // Place actual destination marker
            const destLocation = {
                lat: actualDestination.lat,
                lng: actualDestination.lng
            };

            destinationMarker = new google.maps.Marker({
                position: destLocation,
                map: map,
                title: 'Actual Destination',
                label: 'B',
                animation: google.maps.Animation.DROP
            });

            // Update guess marker style
            guessMarker.setLabel('G');

            // Draw line between guess and actual
            distanceLine = new google.maps.Polyline({
                path: [guessPos, destLocation],
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 0.7,
                strokeWeight: 2,
                map: map
            });

            // Fit map to show all markers
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(UNION_STATION);
            bounds.extend(guessPos);
            bounds.extend(destLocation);
            map.fitBounds(bounds);

            // Update destination text
            document.getElementById('destination').textContent = actualDestination.address;

            // Show results
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('result-content');

            resultContent.innerHTML = `
                <div class="result-row"><span class="result-label">Your Score:</span> ${score} / 5000</div>
                <div class="result-row"><span class="result-label">Distance Off:</span> ${distanceKm.toFixed(2)} km (${distanceMiles.toFixed(2)} miles)</div>
                <div class="result-row"><span class="result-label">Actual Location:</span> ${actualDestination.address}</div>
                <div class="result-row" style="margin-top: 10px;">
                    <span style="color: #FFA500;">‚¨§ G</span> = Your Guess &nbsp;&nbsp;
                    <span style="color: #1a73e8;">üìç B</span> = Actual Destination
                </div>
            `;
            resultDiv.style.display = 'block';

            // Show new game button
            document.getElementById('newGameBtn').style.display = 'block';

            // Update instructions
            document.getElementById('instructions').innerHTML = 'Click "New Game" to play again!';
            document.getElementById('instructions').style.background = '#d4edda';
            document.getElementById('instructions').style.color = '#155724';
        }

        // Initialize map when page loads
        window.initMap = initMap;
    </script>

    <!-- Load Google Maps API dynamically using server-side env-backed endpoint -->
    <script>
        (async function() {
            try {
                // Ask the backend for the API key; backend reads GOOGLE_MAPS_API_KEY from env
                const response = await fetch('/maps-api-key');
                if (!response.ok) {
                    throw new Error('Failed to fetch Maps API key');
                }

                const data = await response.json();
                const apiKey = data.googleMapsApiKey;

                if (!apiKey) {
                    throw new Error('Maps API key is missing from backend response');
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            } catch (err) {
                console.error('Failed to load Google Maps API:', err);
                const mapEl = document.getElementById('map');
                if (mapEl) {
                    mapEl.textContent = 'Failed to load map. Please check the server-side GOOGLE_MAPS_API_KEY configuration.';
                }
            }
        })();
    </script>
</body>
</html>
